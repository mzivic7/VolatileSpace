### LEAVE COI ###

# DETECTING #

# using orbital-physics/11-orbit-points.txt
# for calculating position of leave_coi point

# using same method as in other-physics/3-warp.txt
# for detecting if vessel will pass leave_coi point in next iteration

# CALCULATING NEW ORBIT #

# vessel absolute position is known
# calculate vessel and reference relative positions (to their references):
ves_rel_pos = ves_abs_pos - ref_abs_pos
ref_rel_pos = ref_abs_pos - ref_ref_abs_pos   # (reference of reference)
# calculate vessel and reference relative velocities (to their references):
ves_ref_vel =   # see bellow notes
ref_rel_vel =   # see bellow notes
# add vessels and its references relative: positions and velocities
new_ref_pos = ves_rel_pos + ref_rel_pos
new_ref_vel = ves_ref_vel + ref_rel_vel
# new standard grav. parameter must be calculated before converting to new orbit:
new_u = gc * mass_of_new_ref
# convert this position and absolute velocity to orbital parameters:
a, ecc, pea, ma, dir =   # see bellow note
# new reference is reference of current reference


### ENTER COI ###
# vessel absolute position is known
# new reference is also known
# calculate vessel and reference relative positions (to their references):
ves_rel_pos = ves_abs_pos - old_ref_abs_pos
new_ref_rel_pos = new_ref_abs_pos - old_ref_abs_pos
# calculate vessel and reference relative velocities (to their references):
ves_ref_vel =   # see bellow notes
new_ref_rel_vel =   # see bellow notes
# subtract vessels and new reference relative: positions and velocities
new_ref_pos = ves_rel_pos - new_ref_rel_pos
new_ref_vel = ves_ref_vel - new_ref_rel_vel
# new standard grav. parameter must be calculated before converting to new orbit:
new_u = gc * mass_of_new_ref
# convert this position and absolute velocity to orbital parameters:
a, ecc, pea, ma, dir =   # see bellow note
# new reference is defined when obtaining leave_coi point (orbital-physics/11-orbit-points.txt)


# NOTES #
# using orbital-physics/7-inverse-ellipse-equations.txt
# using orbital-physics/8-inverse-hyperola-equations.txt
# for calculating vessel and reference velocity

# using orbital-physics/3-keplerian-orbit.txt
# for calculating orbital parameters from vessel position and velocity
